#!/usr/bin/env bash
set -euo pipefail

# ----------------------------------------
# Args
# ----------------------------------------
MODEL_NAME=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --model_name)
      MODEL_NAME="${2:-}"
      shift 2
      ;;
    *)
      echo "Unknown argument: $1"
      echo "Usage: ./build --model_name <MODEL_NAME>"
      exit 1
      ;;
  esac
done

if [[ -z "$MODEL_NAME" ]]; then
  echo "Usage: ./build --model_name <MODEL_NAME>"
  exit 1
fi

# ----------------------------------------
# Paths (always relative to script location)
# ----------------------------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

REQ_FILE="${SCRIPT_DIR}/requirements.txt"
OPENCOMPASS_DIR="${SCRIPT_DIR}/Src/Evaluation/opencompass"
DECOMPOSE_DIR="${SCRIPT_DIR}/Src/Build"

# Routing history base dir (download target)
ROUTING_HISTORY_BASE="${SCRIPT_DIR}/Src/Train/src/Routing_history"

# Hugging Face dataset repo
HF_REPO_ID="CECAR-Project/cecar_dataset"

# ----------------------------------------
# 1) Install OpenCompass (editable) FIRST
# ----------------------------------------
if [[ ! -d "$OPENCOMPASS_DIR" ]]; then
  echo "OpenCompass dir not found: $OPENCOMPASS_DIR"
  exit 1
fi

cd "$OPENCOMPASS_DIR"
python3 -m pip install -e . -q
cd "$SCRIPT_DIR"

# ----------------------------------------
# 2) Install python requirements
# ----------------------------------------
if [[ ! -f "$REQ_FILE" ]]; then
  echo "Requirements file not found: $REQ_FILE"
  exit 1
fi

python3 -m pip install --upgrade pip -q
python3 -m pip install -r "$REQ_FILE" -q 2>/dev/null

# ----------------------------------------
# 2.5) Download routing_history dataset from Hugging Face (with SKIP)
#      Timing: right after python requirements install
# ----------------------------------------
mkdir -p "$ROUTING_HISTORY_BASE"
export ROUTING_HISTORY_BASE HF_REPO_ID

python3 - <<'PY'
import os
import sys

try:
    from huggingface_hub import hf_hub_download
except Exception:
    print("[ERROR] huggingface_hub is not available. Please add 'huggingface_hub' to requirements.txt.")
    raise

ROUTING_HISTORY_BASE = os.environ["ROUTING_HISTORY_BASE"]
HF_REPO_ID = os.environ["HF_REPO_ID"]

models = [
    "DeepSeek_v2_Lite_Chat",
    "OLMoE_1B_7B_0125_Instruct",
    "Qwen3_30B_A3B",
]
tasks = ["gpqa", "humaneval", "math", "mbpp", "triviaqa"]

def ensure_dir(path: str):
    os.makedirs(path, exist_ok=True)

def maybe_download(filename: str, dest_dir: str):
    ensure_dir(dest_dir)
    target_path = os.path.join(dest_dir, filename)

    if os.path.isfile(target_path):
        print(f"[SKIP] {filename} already exists")
        return target_path

    print(f"[DL]   {filename}")
    return hf_hub_download(
        repo_id=HF_REPO_ID,
        filename=filename,
        repo_type="dataset",
        local_dir=dest_dir,
        local_dir_use_symlinks=False,
    )

print(f"[INFO] Download routing_history from HF dataset: {HF_REPO_ID}")
print(f"[INFO] Target base dir: {ROUTING_HISTORY_BASE}")

downloaded = 0
skipped = 0

for model in models:
    model_dir = os.path.join(ROUTING_HISTORY_BASE, model)
    for task in tasks:
        fname = f"{model}_{task}.pt"
        local_path = os.path.join(model_dir, fname)

        if os.path.isfile(local_path):
            skipped += 1
            print(f"[SKIP] {fname}")
            continue

        try:
            maybe_download(fname, model_dir)
            downloaded += 1
        except Exception as e:
            print(f"[ERROR] Failed to download {fname}: {e}")
            sys.exit(1)

print(f"[OK] routing_history ready | downloaded={downloaded}, skipped={skipped}")
PY

# ----------------------------------------
# 3) Run Decompose
# ----------------------------------------
if [[ ! -d "$DECOMPOSE_DIR" ]]; then
  echo "Build dir not found: $DECOMPOSE_DIR"
  exit 1
fi

cd "$DECOMPOSE_DIR"
python3 Decompose_moe_model_repo.py \
  --model_name "$MODEL_NAME"

cd "$SCRIPT_DIR"
echo "[OK] build finished: --model_name ${MODEL_NAME}"
